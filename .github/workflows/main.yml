# File: .github/workflows/daebook-rdp.yml
name: DaeBook RDP
on:
  workflow_dispatch:

jobs:
  daebook-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:

      - name: Cleanup & Free Port 80 + 443 (100% Hijau & Bersih)
        shell: powershell
        run: |
          # Hanya kill proses yang bukan System (PID 4 = HTTP.sys, jangan diganggu)
          foreach ($port in 80, 443) {
            Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue |
              Where-Object { $_.OwningProcess -ne 4 } |
              ForEach-Object {
                Write-Host "Menghentikan PID $($_.OwningProcess) yang pakai port $port"
                Stop-Process -Id $_.OwningProcess -Force -ErrorAction SilentlyContinue
              }
          }

          # Hapus reservation HTTP.sys tanpa error (suppress semua output error)
          $urls = "http://+:80/","https://+:443/","http://*:80/","https://*:443/"
          foreach ($url in $urls) {
            netsh http delete urlacl url=$url 2>$null | Out-Null
          }

          # Stop IIS dan service terkait (jika ada)
          Stop-Service -Name W3SVC,WAS -Force -ErrorAction SilentlyContinue
          iisreset /stop 2>$null | Out-Null

          Write-Host "Port 80 dan 443 sudah 100% bebas dan siap dipakai!"

      - name: Enable RDP + Buka Port 3389
        shell: powershell
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="DaeBook-RDP" 2>$null | Out-Null
          netsh advfirewall firewall add rule name="DaeBook-RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Buat User DaeBook (Admin Full)
        shell: powershell
        run: |
          $Password = (-join ((65..90) + (97..122) + (48..57) + (33,35,36,64,94) | Get-Random -Count 22 | % {[char]$_}))
          $Secure = ConvertTo-SecureString $Password -AsPlainText -Force

          New-LocalUser "DaeBook" -Password $Secure -FullName "DaeBook" -Description "RDP via GitHub Actions" -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "DaeBook"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "DaeBook"

          echo "DAEBOOK_PASS=$Password" >> $env:GITHUB_ENV
          Write-Host "User DaeBook berhasil dibuat"

      - name: Install Tailscale Terbaru
        shell: powershell
        run: |
          iwr -useb https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile "$env:TEMP\ts.msi"
          Start-Process msiexec.exe -Wait -ArgumentList '/i', "$env:TEMP\ts.msi", '/quiet', '/norestart'
          Remove-Item "$env:TEMP\ts.msi" -Force

      - name: Connect Tailscale
        shell: powershell
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=daebook-${{ github.run_id }} --accept-routes --accept-dns=false

          for ($i = 0; $i -lt 20; $i++) {
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
            if ($ip) { 
              echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
              Write-Host "Tailscale IP: $ip"
              break 
            }
            Start-Sleep -Seconds 6
          }
          if (-not $env:TAILSCALE_IP) { Write-Error "Gagal konek Tailscale"; exit 1 }

      - name: INFO RDP + Keep Alive
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "╔══════════════════════════════════════════════════╗"
          Write-Host "║               DAEBOOK RDP SUDAH SIAP             ║"
          Write-Host "╚══════════════════════════════════════════════════╝"
          Write-Host "   IP         → ${{ env.TAILSCALE_IP }}"
          Write-Host "   Username   → DaeBook"
          Write-Host "   Password   → ${{ env.DAEBOOK_PASS }}"
          Write-Host "   Port RDP   → 3389"
          Write-Host "   Port 80    → 100% FREE (siap buat apa saja)"
          Write-Host "   Expired    → Otomatis mati setelah 6 jam"
          Write-Host "════════════════════════════════════════════════════"
          Write-Host ""

          while ($true) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] DaeBook aktif — Port 80 free — Cancel manual kalau selesai"
            Start-Sleep -Seconds 300
          }
