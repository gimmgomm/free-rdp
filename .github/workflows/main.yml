name: DaeBook RDP
on: workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:

      - name: Cleanup Port 80 + 443 (Bersih Total)
        shell: powershell
        run: |
          foreach ($p in 80,443) { Get-NetTCPConnection -LocalPort $p -ErrorAction SilentlyContinue | ? OwningProcess -ne 4 | % { Stop-Process $_.OwningProcess -Force -ErrorAction SilentlyContinue } }
          "http://+:80/","https://+:443/","http://*:80/","https://*:443/" | % { netsh http delete urlacl url=$_ 2>$null | Out-Null }
          Stop-Service W3SVC,WAS -Force -ErrorAction SilentlyContinue 2>$null
          Write-Host "Port 80 & 443 sudah bebas"

      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          netsh advfirewall firewall add rule name="DaeBook-RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create User DaeBook
        shell: powershell
        run: |
          $Pass = (-join ((65..90)+(97..122)+(48..57)+(33,35,36,64) | Get-Random -Count 22 | % {[char]$_}))
          $Sec  = ConvertTo-SecureString $Pass -AsPlainText -Force
          New-LocalUser "DaeBook" -Password $Sec -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators","Remote Desktop Users" -Member "DaeBook"
          echo "DAEBOOK_PASS=$Pass" >> $env:GITHUB_ENV

      - name: Install & Connect Tailscale (Fixed 100%)
        shell: powershell
        run: |
          iwr -useb https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile "$env:TEMP\ts.msi"
          msiexec /i "$env:TEMP\ts.msi" /quiet /norestart | Wait-Process

          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=daebook-${{ github.run_id }} --accept-routes --accept-dns=false

          # Tunggu maksimal 30 detik sampai IP muncul
          for ($i = 0; $i -lt 30; $i++) {
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null | Select-Object -First 1
            if ($ip -and $ip -match '\d+\.\d+\.\d+\.\d+') {
              echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
              Write-Host "Tailscale connected → $ip"
              break
            }
            Start-Sleep -Seconds 1
          }

          # Pastikan variabel benar-benar ter-set sebelum lanjut
          if (!$env:TAILSCALE_IP) {
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          }

          Write-Host "Final IP: $env:TAILSCALE_IP"

      - name: INFO RDP + Keep Alive
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "╔══════════════════════════════════════╗"
          Write-Host "║       DAEBOOK RDP 100% READY         ║"
          Write-Host "╚══════════════════════════════════════╝"
          Write-Host "IP       → ${{ env.TAILSCALE_IP }}"
          Write-Host "User     → DaeBook"
          Write-Host "Pass     → ${{ env.DAEBOOK_PASS }}"
          Write-Host "RDP Port → 3389"
          Write-Host "Web Port → 80 (FREE)"
          Write-Host "Expire   → 6 jam"
          Write-Host "════════════════════════════════════════"
          while ($true) { Write-Host "[$(Get-Date -f HH:mm:ss)] DaeBook aktif"; Start-Sleep 300 }
