name: RDP

on:
  workflow_dispatch:

jobs:
  rdp-daebook:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Restart-Service TermService -Force

      - name: Buat User DaeBook + Random Password Administrator
        run: |
          $daePass = -join ((65..90 + 97..122 + 48..57 + 33,35,36,64,94) | Get-Random -Count 24 | % {[char]$_})
          $adminPass = -join ((65..90 + 97..122 + 48..57 + 33,35,36,64,94) | Get-Random -Count 28 | % {[char]$_})
          $daeSec  = ConvertTo-SecureString $daePass -AsPlainText -Force
          $adminSec = ConvertTo-SecureString $adminPass -AsPlainText -Force

          New-LocalUser -Name "DaeBook" -Password $daeSec -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "DaeBook"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "DaeBook"

          net user Administrator $adminPass
          net user Administrator /active:yes

          echo "DAE_PASS=$daePass" >> $env:GITHUB_ENV
          echo "ADMIN_PASS=$adminPass" >> $env:GITHUB_ENV

      - name: Install & Connect Tailscale
        run: |
          iwr https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile ts.msi
          msiexec /i ts.msi /quiet /norestart
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=dae-${{ github.run_id }} --accept-risk=all

          for($i=0;$i -lt 20;$i++){
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
            if($ip){echo "TS_IP=$ip" >> $env:GITHUB_ENV; break}
            Start-Sleep 4
          }

      - name: Forward port 80 → 3389
        run: |
          netsh interface portproxy delete v4tov4 listenport=80 listenaddress=0.0.0.0 | Out-Null
          netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=3389 connectaddress=127.0.0.1
          netsh advfirewall firewall add rule name="RDP-80" dir=in action=allow protocol=TCP localport=80

      - name: Tampilkan Kredensial + Keep Alive
        run: |
          Write-Host ""
          Write-Host "════════════════════════════════════════"
          Write-Host "           RDP SUDAH SIAP (PORT 80)     "
          Write-Host "════════════════════════════════════════"
          Write-Host "IP        : $($env:TS_IP):80"
          Write-Host "User 1    : DaeBook"
          Write-Host "Pass 1    : $($env:DAE_PASS)"
          Write-Host "User 2    : Administrator"
          Write-Host "Pass 2    : $($env:ADMIN_PASS)"
          Write-Host "════════════════════════════════════════"
          while($true){ Write-Host "[$(Get-Date -Format HH:mm:ss)] Aktif → $($env:TS_IP):80"; Start-Sleep 300 }
